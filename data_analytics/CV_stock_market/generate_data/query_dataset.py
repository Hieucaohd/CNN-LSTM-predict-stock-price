Date = "Date"
Macd = "Macd"
Macd_signal = "Macd_signal"
Macd_histogram = "Macd_histogram"
BB_avg = "BB_avg"
BB_high = "BB_high"
BB_low = "BB_low"
SMA = "SMA"
EMA_50 = "EMA_50"
EMA_9 = "EMA_9"
EMA_200 = "EMA_200"
Close = "Close"

data_stock = "data_stock"

data_stock_sub_1 = "data_stock_sub_1"
data_stock_include_previous_date = "data_stock_include_previous_date"
bullish_engulfing = "bullish_engulfing"
data_stock_sub_2 = "data_stock_sub_2"
data_stock_sub_3 = "data_stock_sub_3"
bearish_engulfing = "bearish_engulfing"
data_stock_sub_4 = "data_stock_sub_4"
data_stock_include_past_and_future_date = "data_stock_include_past_and_future_date"
data_stock_include_engulfing = "data_stock_include_engulfing"
recent_engulfing_type = "days_start_engulfing"
data_stock_day_bearish_engulfing = "data_stock_day_bearish_engulfing"
data_stock_include_group_engulfing = "data_stock_include_group_engulfing"
data_stock_include_group_engulfing_sub_1 = "data_stock_include_group_engulfing_sub_1"
start_and_end_date_of_group_engulfing = "start_and_end_date_of_group_engulfing"
data_stock_include_harami = "data_stock_include_harami"
data_stock_include_tweezer = "data_stock_include_tweezer"
data_stock_include_morning_and_evening_star = "data_stock_include_morning_and_evening_star"
data_stock_include_next_3_day = "data_stock_include_next_3_day"
recent_next_3_day_type = "recent_next_3_day_type"
data_stock_include_group_next_3_day = "data_stock_include_group_next_3_day"
data_stock_include_group_next_3_day_sub_1 = "data_stock_include_group_next_3_day_sub_1"
data_stock_include_group_sideway = "data_stock_include_group_sideway"
last_candle_index_in_group_next_3_day = "last_candle_index_in_group_next_3_day"
last_candle_index_in_group_next_3_day_sub_1 = "last_candle_index_in_group_next_3_day_sub_1"
data_stock_base = "data_stock_base"

Date = "Date"
Close = "Close"
Open = "Open"
High = "High"
Low = "Low"
Macd = "Macd"
Macd_signal = "Macd_signal"
Macd_histogram = "Macd_histogram"

Date_normalized = "Date_normalized"
Body_height = "Body_height"
Max_body_height_in_one_month_around = "Max_body_height_in_one_month_around"
Max_of_candle_body = "Max_of_candle_body"
Min_of_candle_body = "Min_of_candle_body"
Is_star_doji_candle = "Is_star_doji_candle"
Is_candle_up = "Is_candle_up"
Is_narrow_body_candle = "Is_narrow_body_candle"
Is_dragonfly_doji_candle = "Is_dragonfly_doji_candle"
Is_gravestone_doji_candle = "Is_gravestone_doji_candle"

Previous_date = "Previous_date"
Close_of_previous_day = "Close_of_previous_day"
Open_of_previous_day = "Open_of_previous_day"
High_of_previous_day = "High_of_previous_day"
Low_of_previous_day = "Low_of_previous_day"
Is_previous_day_candle_up = "Is_previous_day_candle_up"
Body_height_of_previous_day = "Body_height_of_previous_day"
Is_previous_day_start_doji_candle = "Is_previous_day_start_doji_candle"
Max_of_candle_body_of_previous_day = "Max_of_candle_body_of_previous_day"
Min_of_candle_body_of_previous_day = "Min_of_candle_body_of_previous_day"

Next_date = "Next_date"
Close_of_next_day = "Close_of_next_day"
Open_of_next_day = "Open_of_next_day"
High_of_next_day = "High_of_next_day"
Low_of_next_day = "Low_of_next_day"
Is_next_day_candle_up = "Is_next_day_candle_up"
Is_next_day_start_doji_candle = "Is_next_day_start_doji_candle"
Body_height_of_next_day = "Body_height_of_next_day"
Max_of_candle_body_of_next_day = "Max_of_candle_body_of_next_day"
Min_of_candle_body_of_next_day = "Min_of_candle_body_of_next_day"

Is_start_bullish_engulfing_candle = "Is_start_bullish_engulfing_candle"
Is_start_bearish_engulfing_candle = "Is_start_bearish_engulfing_candle"
Is_recent_candle_is_bullish_engulfing = "Is_recent_candle_is_bullish_engulfing"
Is_recent_candle_is_bearish_engulfing = "Is_recent_candle_is_bearish_engulfing"

Group_id_engulfing = "Group_id_engulfing"
Start_date_of_group = "Start_date_of_group"
End_date_of_group = "End_date_of_group"
Number_days_in_group = "Number_days_in_group"
Group_engulfing_type = "Group_engulfing_type"
Start_engulfing_candle_type = "Start_engulfing_candle_type"

GROUP_BULL = "GROUP_BULL"
GROUP_BEAR = "GROUP_BEAR"
GROUP_SIZEWAY = "GROUP_SIZEWAY"

Is_start_harami_up_candle = "Is_start_harami_up_candle"
Is_start_harami_down_candle = "Is_start_harami_down_candle"

Is_start_tweezer_top_candle = "Is_start_tweezer_top_candle"
Is_start_tweezer_bottom_candle = "Is_start_tweezer_bottom_candle"

Is_marubozu_candle = "Is_marubozu_candle"

Next_2_date = "Next_2_date"
Close_of_next_2_day = "Close_of_next_2_day"
Open_of_next_2_day = "Open_of_next_2_day"
High_of_next_2_day = "High_of_next_2_day"
Low_of_next_2_day = "Low_of_next_2_day"
Is_next_2_day_candle_up = "Is_next_2_day_candle_up"
Is_next_2_day_start_doji_candle = "Is_next_2_day_start_doji_candle"
Body_height_of_next_2_day = "Body_height_of_next_2_day"
Max_of_candle_body_of_next_2_day = "Max_of_candle_body_of_next_2_day"
Min_of_candle_body_of_next_2_day = "Min_of_candle_body_of_next_2_day"


Is_start_morning_star_candle = "Is_start_morning_star_candle"
Is_start_evening_star_candle = "Is_start_evening_star_candle"

Is_hammer_candle = "Is_hammer_candle"
Is_inverted_hammer_candle = "Is_inverted_hammer_candle"

Is_spin_candle = "Is_spin_candle"

Is_start_next_3_day_up_candle = "Is_start_next_3_day_up_candle"
Is_start_next_3_day_down_candle = "Is_start_next_3_day_down_candle"

Total_records = "Total_records"

Is_recent_candle_is_next_3_day_up = "Is_recent_candle_is_next_3_day_up"
Is_recent_candle_is_next_3_day_down = "Is_recent_candle_is_next_3_day_down"

Group_id_next_3_day = "Group_id_next_3_day"
Start_next_3_day_candle_type = "Start_next_3_day_candle_type"
Group_next_3_day_type = "Group_next_3_day_type"


Group_trend_3_day_type = "Group_trend_3_day_type"
Index_in_group_next_3_day = "Index_in_group_next_3_day"
Max_index_in_group_next_3_day = "Max_index_in_group_next_3_day"

mapping_trend_type = {
    GROUP_BULL: 1,
    GROUP_BEAR: -1,
    GROUP_SIZEWAY: 0
}


def get_base_query():
    base_query = f"""
        WITH
        {data_stock_sub_1} AS (
            SELECT
                *,
                CASE
                    WHEN 
                        {Is_narrow_body_candle} 
                        AND ABS({High} - {Max_of_candle_body}) / ABS({Low} - {Min_of_candle_body}) * 100 BETWEEN 90 AND 110 
                    THEN True
                    ELSE False
                END AS {Is_star_doji_candle},
                CASE
                    WHEN
                        {Is_narrow_body_candle} 
                        AND ABS({High} - {Max_of_candle_body}) / ABS({Low} - {Min_of_candle_body}) * 100 <= 10
                    THEN True
                    ELSE False
                END AS {Is_dragonfly_doji_candle},
                CASE
                    WHEN
                        {Is_narrow_body_candle} 
                        AND ABS({Low} - {Min_of_candle_body}) / ABS({High} - {Max_of_candle_body}) * 100 <= 10
                    THEN True
                    ELSE False
                END AS {Is_gravestone_doji_candle},
                CASE
                    WHEN
                        ABS({High} - {Max_of_candle_body}) / {Body_height} * 100 <= 2
                        AND ABS({Low} - {Min_of_candle_body}) / {Body_height} * 100 <= 2
                    THEN True
                    ELSE False
                END AS {Is_marubozu_candle},
                CASE
                    WHEN 
                        ABS({Low} - {Min_of_candle_body}) / {Body_height} >= 2
                        AND ABS({High} - {Max_of_candle_body}) / {Body_height} * 100 <= 2
                    THEN True
                    ELSE False
                END AS {Is_hammer_candle},
                CASE
                    WHEN 
                        ABS({High} - {Max_of_candle_body}) / {Body_height} >= 2
                        AND ABS({Low} - {Min_of_candle_body}) / {Body_height} * 100 <= 2
                    THEN True
                    ELSE False
                END AS {Is_inverted_hammer_candle},
                CASE
                    WHEN 
                        {Body_height} / {Max_body_height_in_one_month_around} * 100 <= 20
                        AND ABS({High} - {Max_of_candle_body}) / ABS({Low} - {Min_of_candle_body}) * 100 BETWEEN 90 AND 110 
                    THEN True
                    ELSE False
                END AS {Is_spin_candle}
            FROM (
                SELECT
                    *,
                    CASE
                        WHEN
                            {Body_height} / {Max_body_height_in_one_month_around} * 100 <= 2 THEN True
                        ELSE False
                    END AS {Is_narrow_body_candle}
                FROM (
                    SELECT
                        *,
                        MAX({Body_height}) OVER(ORDER BY {Date_normalized} ROWS BETWEEN 15 PRECEDING AND 15 FOLLOWING) AS {Max_body_height_in_one_month_around}
                    FROM (
                        SELECT
                            TO_DATE(CAST({Date} AS TIMESTAMP)) AS {Date_normalized},
                            {Close},
                            {Open},
                            {High},
                            {Low},
                            {Macd},
                            {Macd_signal},
                            {Macd_histogram},
                            CASE
                                WHEN {Close} < {Open} THEN False
                                ELSE True
                            END AS {Is_candle_up},
                            GREATEST({Open}, {Close}) AS {Max_of_candle_body},
                            LEAST({Open}, {Close}) AS {Min_of_candle_body},
                            ABS({Open} - {Close}) AS {Body_height},
                            *
                        FROM {data_stock}
                        ORDER BY {Date}
                    ) AS {data_stock_sub_2}
                ) AS {data_stock_sub_3}
            ) AS {data_stock_sub_4}
        )
        ,
        {data_stock_include_past_and_future_date} AS (
            SELECT
                *,
                LAG({Date_normalized}, 1, {Date_normalized}) OVER(ORDER BY {Date_normalized}) AS {Previous_date},
                LAG({Close}, 1, 0) OVER(ORDER BY {Date_normalized}) AS {Close_of_previous_day},
                LAG({Open}, 1, 0) OVER(ORDER BY {Date_normalized}) AS {Open_of_previous_day},
                LAG({High}, 1, 0) OVER(ORDER BY {Date_normalized}) AS {High_of_previous_day},
                LAG({Low}, 1, 0) OVER(ORDER BY {Date_normalized}) AS {Low_of_previous_day},
                LAG({Is_candle_up}) OVER(ORDER BY {Date_normalized}) AS {Is_previous_day_candle_up},
                LAG({Is_star_doji_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_previous_day_start_doji_candle},
                LAG({Body_height}) OVER(ORDER BY {Date_normalized}) AS {Body_height_of_previous_day},
                LAG({Max_of_candle_body}) OVER(ORDER BY {Date_normalized}) AS {Max_of_candle_body_of_previous_day},
                LAG({Min_of_candle_body}) OVER(ORDER BY {Date_normalized}) AS {Min_of_candle_body_of_previous_day},
                
                LEAD({Date_normalized}) OVER(ORDER BY {Date_normalized}) AS {Next_date},
                LEAD({Close}) OVER(ORDER BY {Date_normalized}) AS {Close_of_next_day},
                LEAD({Open}) OVER(ORDER BY {Date_normalized}) AS {Open_of_next_day},
                LEAD({High}) OVER(ORDER BY {Date_normalized}) AS {High_of_next_day},
                LEAD({Low}) OVER(ORDER BY {Date_normalized}) AS {Low_of_next_day},
                LEAD({Is_candle_up}) OVER(ORDER BY {Date_normalized}) AS {Is_next_day_candle_up},
                LEAD({Is_star_doji_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_next_day_start_doji_candle},
                LEAD({Body_height}) OVER(ORDER BY {Date_normalized}) AS {Body_height_of_next_day},
                LEAD({Max_of_candle_body}) OVER(ORDER BY {Date_normalized}) AS {Max_of_candle_body_of_next_day},
                LEAD({Min_of_candle_body}) OVER(ORDER BY {Date_normalized}) AS {Min_of_candle_body_of_next_day},

                LEAD({Date_normalized}, 2) OVER(ORDER BY {Date_normalized}) AS {Next_2_date},
                LEAD({Close}, 2) OVER(ORDER BY {Date_normalized}) AS {Close_of_next_2_day},
                LEAD({Open}, 2) OVER(ORDER BY {Date_normalized}) AS {Open_of_next_2_day},
                LEAD({High}, 2) OVER(ORDER BY {Date_normalized}) AS {High_of_next_2_day},
                LEAD({Low}, 2) OVER(ORDER BY {Date_normalized}) AS {Low_of_next_2_day},
                LEAD({Is_candle_up}, 2) OVER(ORDER BY {Date_normalized}) AS {Is_next_2_day_candle_up},
                LEAD({Is_star_doji_candle}, 2) OVER(ORDER BY {Date_normalized}) AS {Is_next_2_day_start_doji_candle},
                LEAD({Body_height}, 2) OVER(ORDER BY {Date_normalized}) AS {Body_height_of_next_2_day},
                LEAD({Max_of_candle_body}, 2) OVER(ORDER BY {Date_normalized}) AS {Max_of_candle_body_of_next_2_day},
                LEAD({Min_of_candle_body}, 2) OVER(ORDER BY {Date_normalized}) AS {Min_of_candle_body_of_next_2_day}
            FROM {data_stock_sub_1}
        )
        ,
        {data_stock_include_engulfing} AS (
            SELECT
                *,
                CASE
                    WHEN 
                        NOT {Is_candle_up} 
                        AND {Is_next_day_candle_up} 
                        AND {Max_of_candle_body} < {Max_of_candle_body_of_next_day} 
                        AND ABS({Min_of_candle_body} - {Min_of_candle_body_of_next_day}) / {Body_height_of_next_day} * 100  <= 10 
                        AND {Body_height} / {Body_height_of_next_day} * 100 BETWEEN 15 AND 50
                    THEN True
                    ELSE False
                END AS {Is_start_bullish_engulfing_candle},
                CASE
                    WHEN
                        {Is_candle_up} 
                        AND NOT {Is_next_day_candle_up} 
                        AND {Min_of_candle_body} > {Min_of_candle_body_of_next_day} 
                        AND ABS({Max_of_candle_body} - {Max_of_candle_body_of_next_day}) / {Body_height_of_next_day} * 100  <= 10 
                        AND {Body_height} / {Body_height_of_next_day} * 100 BETWEEN 15 AND 50
                    THEN True
                    ELSE False
                END AS {Is_start_bearish_engulfing_candle}
            FROM {data_stock_include_past_and_future_date}
        )
        ,
        {recent_engulfing_type} AS (
            SELECT
                {Date_normalized},
                LAG({Is_start_bullish_engulfing_candle}, 1, {Is_start_bullish_engulfing_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_recent_candle_is_bullish_engulfing},
                LAG({Is_start_bearish_engulfing_candle}, 1, {Is_start_bearish_engulfing_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_recent_candle_is_bearish_engulfing}
            FROM {data_stock_include_engulfing}
            WHERE {Is_start_bullish_engulfing_candle} OR {Is_start_bearish_engulfing_candle}
        )
        ,
        {data_stock_include_group_engulfing} AS (
            SELECT
                *,
                MAX({Start_engulfing_candle_type}) OVER(PARTITION BY {Group_id_engulfing}) AS {Group_engulfing_type}
            FROM (
                SELECT
                    {data_stock_include_engulfing}.*,
                    SUM(
                        CASE
                            WHEN {Is_start_bullish_engulfing_candle} AND {Is_recent_candle_is_bearish_engulfing} THEN 1
                            WHEN {Is_start_bearish_engulfing_candle} AND {Is_recent_candle_is_bullish_engulfing} THEN 1
                            ELSE 0
                        END
                    ) OVER(ORDER BY {data_stock_include_engulfing}.{Date_normalized}) AS {Group_id_engulfing},
                    CASE
                        WHEN {Is_start_bullish_engulfing_candle} THEN "{GROUP_BULL}"
                        WHEN {Is_start_bearish_engulfing_candle} THEN "{GROUP_BEAR}"
                        ELSE ""
                    END AS {Start_engulfing_candle_type}
                FROM {data_stock_include_engulfing} 
                LEFT JOIN {recent_engulfing_type}
                    ON {recent_engulfing_type}.{Date_normalized} = {data_stock_include_engulfing}.{Date_normalized}
            ) AS {data_stock_include_group_engulfing_sub_1}
        )
        ,
        {start_and_end_date_of_group_engulfing} AS (
            SELECT
                {Group_id_engulfing},
                {Group_engulfing_type},
                MIN({data_stock_include_group_engulfing}.{Date_normalized}) AS {Start_date_of_group},
                MAX({data_stock_include_group_engulfing}.{Date_normalized}) AS {End_date_of_group},
                COUNT(*) AS {Number_days_in_group}
            FROM {data_stock_include_group_engulfing} 
            GROUP BY {Group_id_engulfing}, {Group_engulfing_type}
        )
        ,
        {data_stock_include_harami} AS (
            SELECT
                *,
                CASE
                    WHEN 
                        NOT {Is_candle_up} 
                        AND {Is_next_day_candle_up} 
                        AND {Max_of_candle_body} > {Max_of_candle_body_of_next_day} 
                        AND ABS({Min_of_candle_body} - {Min_of_candle_body_of_next_day}) / {Body_height} * 100  <= 10 
                        AND {Body_height} > {Body_height_of_next_day}
                    THEN True
                    ELSE False
                END AS {Is_start_harami_up_candle},
                CASE
                    WHEN
                        {Is_candle_up} 
                        AND NOT {Is_next_day_candle_up} 
                        AND {Min_of_candle_body} < {Min_of_candle_body_of_next_day} 
                        AND ABS({Max_of_candle_body} - {Max_of_candle_body_of_next_day}) / {Body_height} * 100  <= 10 
                        AND {Body_height} > {Body_height_of_next_day}
                    THEN True
                    ELSE False
                END AS {Is_start_harami_down_candle}
            FROM {data_stock_include_group_engulfing}
        )
        ,
        {data_stock_include_tweezer} AS (
            SELECT
                *,
                CASE 
                    WHEN 
                        {Is_candle_up}
                        AND NOT {Is_next_day_candle_up}
                        AND {Body_height} / {Body_height_of_next_day} * 100 BETWEEN 90 AND 110
                    THEN True
                    ELSE False
                END AS {Is_start_tweezer_top_candle},
                CASE 
                    WHEN 
                        NOT {Is_candle_up}
                        AND {Is_next_day_candle_up}
                        AND {Body_height} / {Body_height_of_next_day} * 100 BETWEEN 90 AND 110
                    THEN True
                    ELSE False
                END AS {Is_start_tweezer_bottom_candle}
                
            FROM {data_stock_include_harami}
        )
        ,
        {data_stock_include_morning_and_evening_star} AS (
            SELECT
                *,
                CASE
                    WHEN
                        NOT {Is_candle_up}
                        AND {Is_next_2_day_candle_up}
                        AND {Body_height_of_next_day} / {Body_height} * 100 <= 20
                        AND {Body_height_of_next_day} / {Body_height_of_next_2_day} * 100 <= 20
                    THEN True
                    ELSE False
                END AS {Is_start_morning_star_candle},
                CASE
                    WHEN
                        {Is_candle_up}
                        AND NOT {Is_next_2_day_candle_up}
                        AND {Body_height_of_next_day} / {Body_height} * 100 <= 20
                        AND {Body_height_of_next_day} / {Body_height_of_next_2_day} * 100 <= 20
                    THEN True
                    ELSE False
                END AS {Is_start_evening_star_candle}
            FROM {data_stock_include_tweezer}
        )
        ,
        {data_stock_include_next_3_day} AS (
            SELECT
                *,
                CASE
                    WHEN 
                        {Is_candle_up}
                        AND {Is_next_day_candle_up}
                        AND {Is_next_2_day_candle_up}
                        AND NOT {Is_next_2_day_start_doji_candle}
                    THEN True
                    ELSE False
                END AS {Is_start_next_3_day_up_candle},
                CASE
                    WHEN 
                        NOT {Is_candle_up}
                        AND NOT {Is_next_day_candle_up}
                        AND NOT {Is_next_2_day_candle_up}
                        AND NOT {Is_next_2_day_start_doji_candle}
                    THEN True
                    ELSE False
                END AS {Is_start_next_3_day_down_candle}
            FROM {data_stock_include_morning_and_evening_star}
        )
        ,
        {recent_next_3_day_type} AS (
            SELECT
                {Date_normalized},
                LAG({Is_start_next_3_day_up_candle}, 1, {Is_start_next_3_day_up_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_recent_candle_is_next_3_day_up},
                LAG({Is_start_next_3_day_down_candle}, 1, {Is_start_next_3_day_down_candle}) OVER(ORDER BY {Date_normalized}) AS {Is_recent_candle_is_next_3_day_down}
            FROM {data_stock_include_next_3_day}
            WHERE {Is_start_next_3_day_up_candle} OR {Is_start_next_3_day_down_candle}
        )
        ,
        {data_stock_include_group_next_3_day} AS (
            SELECT
                *,
                MAX({Start_next_3_day_candle_type}) OVER(PARTITION BY {Group_id_next_3_day}) AS {Group_next_3_day_type},
                ROW_NUMBER() OVER(PARTITION BY {Group_id_next_3_day} ORDER BY {Date_normalized}) AS {Index_in_group_next_3_day}
            FROM (
                SELECT
                    {data_stock_include_next_3_day}.*,
                    SUM(
                        CASE
                            WHEN {Is_start_next_3_day_up_candle} AND {Is_recent_candle_is_next_3_day_down} THEN 1
                            WHEN {Is_start_next_3_day_down_candle} AND {Is_recent_candle_is_next_3_day_up} THEN 1
                            ELSE 0
                        END
                    ) OVER(ORDER BY {data_stock_include_next_3_day}.{Date_normalized}) AS {Group_id_next_3_day},
                    CASE
                        WHEN {Is_start_next_3_day_up_candle} THEN "{GROUP_BULL}"
                        WHEN {Is_start_next_3_day_down_candle} THEN "{GROUP_BEAR}"
                        ELSE ""
                    END AS {Start_next_3_day_candle_type}
                FROM {data_stock_include_next_3_day} 
                LEFT JOIN {recent_next_3_day_type}
                    ON {recent_next_3_day_type}.{Date_normalized} = {data_stock_include_next_3_day}.{Date_normalized}
            ) AS {data_stock_include_group_next_3_day_sub_1}
        )
        ,
        {last_candle_index_in_group_next_3_day} AS (
            SELECT
                {Group_id_next_3_day},
                MAX({Max_index_in_group_next_3_day}) AS {Max_index_in_group_next_3_day}
            FROM (
                SELECT
                    *,
                    MAX({Index_in_group_next_3_day}) OVER (PARTITION BY {Group_id_next_3_day}) AS {Max_index_in_group_next_3_day}
                FROM {data_stock_include_group_next_3_day}
                WHERE {Is_start_next_3_day_up_candle} OR {Is_start_next_3_day_down_candle}
            ) AS {last_candle_index_in_group_next_3_day_sub_1}
            GROUP BY {Group_id_next_3_day}
        )
        ,
        {data_stock_include_group_sideway} AS (
            SELECT
                a.*,
                b.{Max_index_in_group_next_3_day},
                CASE
                    WHEN a.{Index_in_group_next_3_day} <= b.{Max_index_in_group_next_3_day} + 2 THEN a.{Group_next_3_day_type}
                    ELSE "{GROUP_SIZEWAY}"
                END AS {Group_trend_3_day_type}
            FROM {data_stock_include_group_next_3_day} AS a
            LEFT JOIN {last_candle_index_in_group_next_3_day} AS b
                ON a.{Group_id_next_3_day} = b.{Group_id_next_3_day}
        )
        ,
        {data_stock_base} AS (
            SELECT
                *
            FROM {data_stock_include_group_sideway}
        )
        
    """
    
    return base_query
